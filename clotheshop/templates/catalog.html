{% extends 'base.html' %}
{% load static %}
{% block content %}
<h1 class="page-title">–ö–∞—Ç–∞–ª–æ–≥ —Ç–æ–≤–∞—Ä–æ–≤</h1>
<link rel="stylesheet" href="{% static 'css/catalog.css' %}?v=1">

<!-- –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è -->
<form method="get" class="filter-form">
    <div class="filter-group">
        <label>–¢–∏–ø:
            <select name="type">
                <option value="">–í—Å–µ</option>
                <option value="–ë–µ—Ä–º—É–¥—ã" {% if current_filters.type == '–ë–µ—Ä–º—É–¥—ã' %}selected{% endif %}>–ë–µ—Ä–º—É–¥—ã</option>
                <option value="–ë—Ä—é–∫–∏" {% if current_filters.type == '–ë—Ä—é–∫–∏' %}selected{% endif %}>–ë—Ä—é–∫–∏</option>
                <option value="–î–∂–∏–Ω—Å—ã" {% if current_filters.type == '–î–∂–∏–Ω—Å—ã' %}selected{% endif %}>–î–∂–∏–Ω—Å—ã</option>
                <option value="–ö–µ–ø–∫–∞" {% if current_filters.type == '–ö–µ–ø–∫–∞' %}selected{% endif %}>–ö–µ–ø–∫–∞</option>
                <option value="–ö–æ—Å—Ç—é–º" {% if current_filters.type == '–ö–æ—Å—Ç—é–º' %}selected{% endif %}>–ö–æ—Å—Ç—é–º</option>
                <option value="–ö—É—Ä—Ç–∫–∞" {% if current_filters.type == '–ö—É—Ä—Ç–∫–∞' %}selected{% endif %}>–ö—É—Ä—Ç–∫–∞</option>
                <option value="–õ–æ–Ω–≥—Å–ª–∏–≤" {% if current_filters.type == '–õ–æ–Ω–≥—Å–ª–∏–≤' %}selected{% endif %}>–õ–æ–Ω–≥—Å–ª–∏–≤</option>
                <option value="–ü–ª–∞—Ç—å–µ" {% if current_filters.type == '–ü–ª–∞—Ç—å–µ' %}selected{% endif %}>–ü–ª–∞—Ç—å–µ</option>
                <option value="–†—É–±–∞—à–∫–∞" {% if current_filters.type == '–†—É–±–∞—à–∫–∞' %}selected{% endif %}>–†—É–±–∞—à–∫–∞</option>
                <option value="–°–≤–∏—Ç–µ—Ä" {% if current_filters.type == '–°–≤–∏—Ç–µ—Ä' %}selected{% endif %}>–°–≤–∏—Ç–µ—Ä</option>
                <option value="–°–≤–∏—Ç—à–æ—Ç" {% if current_filters.type == '–°–≤–∏—Ç—à–æ—Ç' %}selected{% endif %}>–°–≤–∏—Ç—à–æ—Ç</option>
                <option value="–§—É—Ç–±–æ–ª–∫–∞" {% if current_filters.type == '–§—É—Ç–±–æ–ª–∫–∞' %}selected{% endif %}>–§—É—Ç–±–æ–ª–∫–∞</option>
                <option value="–•—É–¥–∏" {% if current_filters.type == '–•—É–¥–∏' %}selected{% endif %}>–•—É–¥–∏</option>
                <option value="–®–∞–ø–∫–∞" {% if current_filters.type == '–®–∞–ø–∫–∞' %}selected{% endif %}>–®–∞–ø–∫–∞</option>
                <option value="–®–æ—Ä—Ç—ã" {% if current_filters.type == '–®–æ—Ä—Ç—ã' %}selected{% endif %}>–®–æ—Ä—Ç—ã</option>
                <option value="–Æ–±–∫–∞" {% if current_filters.type == '–Æ–±–∫–∞' %}selected{% endif %}>–Æ–±–∫–∞</option>
            </select>
        </label>
    </div>

    <div class="filter-group">
        <label>–†–∞–∑–º–µ—Ä:
            <select name="size">
                <option value="">–í—Å–µ —Ä–∞–∑–º–µ—Ä—ã</option>
                {% for size in available_sizes %}
                    <option value="{{ size }}" {% if current_filters.size == size %}selected{% endif %}>{{ size }}</option>
                {% endfor %}
            </select>
        </label>
    </div>

    <div class="filter-group">
        <label>–¶–µ–Ω–∞ –æ—Ç:
            <input type="number" name="price_from" min="0" value="{{ current_filters.price_from|default:'' }}">
        </label>
    </div>

    <div class="filter-group">
        <label>–¥–æ:
            <input type="number" name="price_to" min="0" value="{{ current_filters.price_to|default:'' }}">
        </label>
    </div>

    <div class="filter-buttons">
        <button type="submit">üîç –§–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å</button>
        <a href="{% url 'catalog' %}" class="reset-button">
            <button type="button">üîÑ –°–±—Ä–æ—Å–∏—Ç—å</button>
        </a>
    </div>
</form>

<!-- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤ -->
<div class="product-count">
    <p>–ù–∞–π–¥–µ–Ω–æ —Ç–æ–≤–∞—Ä–æ–≤: <strong>{{ products|length }}</strong></p>
    
    <!-- –ê–∫—Ç–∏–≤–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã -->
    {% if current_filters.type or current_filters.size or current_filters.price_from or current_filters.price_to %}
    <div class="active-filters">
        <span>–ê–∫—Ç–∏–≤–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã:</span>
        {% if current_filters.type %}
            <span class="filter-tag">
                –¢–∏–ø: {{ current_filters.type }}
                <a href="?{% if current_filters.size %}size={{ current_filters.size }}{% endif %}{% if current_filters.price_from %}{% if current_filters.size %}&{% endif %}price_from={{ current_filters.price_from }}{% endif %}{% if current_filters.price_to %}{% if current_filters.size or current_filters.price_from %}&{% endif %}price_to={{ current_filters.price_to }}{% endif %}" class="remove-filter">√ó</a>
            </span>
        {% endif %}
        {% if current_filters.size %}
            <span class="filter-tag">
                –†–∞–∑–º–µ—Ä: {{ current_filters.size }}
                <a href="?{% if current_filters.type %}type={{ current_filters.type }}{% endif %}{% if current_filters.price_from %}{% if current_filters.type %}&{% endif %}price_from={{ current_filters.price_from }}{% endif %}{% if current_filters.price_to %}{% if current_filters.type or current_filters.price_from %}&{% endif %}price_to={{ current_filters.price_to }}{% endif %}" class="remove-filter">√ó</a>
            </span>
        {% endif %}
        {% if current_filters.price_from or current_filters.price_to %}
            <span class="filter-tag">
                –¶–µ–Ω–∞: 
                {% if current_filters.price_from %}{{ current_filters.price_from }}{% else %}0{% endif %} - 
                {% if current_filters.price_to %}{{ current_filters.price_to }}{% else %}‚àû{% endif %} ‚ÇΩ
                <a href="?{% if current_filters.type %}type={{ current_filters.type }}{% endif %}{% if current_filters.size %}{% if current_filters.type %}&{% endif %}size={{ current_filters.size }}{% endif %}" class="remove-filter">√ó</a>
            </span>
        {% endif %}
    </div>
    {% endif %}
</div>

<div class="background-pattern">
    <img src="{% static 'svg/bg_1.svg' %}" class="bg-shape bg-1">
    <img src="{% static 'svg/bg_2.svg' %}" class="bg-shape bg-2">
    <img src="{% static 'svg/bg_3.svg' %}" class="bg-shape bg-3">
    <img src="{% static 'svg/bg_4.svg' %}" class="bg-shape bg-4">
    <img src="{% static 'svg/bg_5.svg' %}" class="bg-shape bg-5">
    <img src="{% static 'svg/bg_6.svg' %}" class="bg-shape bg-6">
    <img src="{% static 'svg/bg_7.svg' %}" class="bg-shape bg-7">
    <img src="{% static 'svg/bg_8.svg' %}" class="bg-shape bg-8">
</div>

<!-- –°–µ—Ç–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤ -->
<div class="product-grid">
    {% for product in products %}
    <div class="product-card">
        <!-- –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ -->
        <div class="product-image">
            {% if product.image %}
                <img src="{{ product.image.url }}" alt="{{ product.name }}">
            {% else %}
                <img src="{% static 'images/item_placeholder.png' %}" alt="{{ product.name }}">
            {% endif %}
        </div>

        <!-- –ö–æ–Ω—Ç–µ–Ω—Ç -->
        <div class="product-card-content">
            <h3 style="margin-top: 0.5rem; font-size: 1.25rem;">{{ product.name }}</h3>

            <p class="product-price">
                {{ product.price }} ‚ÇΩ
            </p>

            <!-- –ö–Ω–æ–ø–∫–∏ -->
            <div class="product-buttons">
                <a href="{% url 'product_detail' product.id %}">
                    <button type="button">üëú –ü—Ä–∏–æ–±—Ä–µ—Å—Ç–∏</button>
                </a>
                <form method="post" action="{% url 'add_to_favorites' product.id %}">
                    {% csrf_token %}
                    <button type="submit">‚ù§Ô∏è</button>
                </form>
            </div>
        </div>
    </div>
    {% endfor %}
</div>

<!-- –°–æ–æ–±—â–µ–Ω–∏–µ, –µ—Å–ª–∏ —Ç–æ–≤–∞—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã -->
{% if not products %}
<div class="no-products">
    <h2>üòî –¢–æ–≤–∞—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</h2>
    <p>–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏</p>
</div>
{% endif %}
{% endblock %}

<script>
// –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ñ–∏–ª—å—Ç—Ä–æ–≤
document.addEventListener('DOMContentLoaded', function() {
    const filterForm = document.querySelector('.filter-form');
    const selects = filterForm.querySelectorAll('select');
    const inputs = filterForm.querySelectorAll('input[type="number"]');
    const productGrid = document.querySelector('.product-grid');
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ –∑–∞–≥—Ä—É–∑–∫–∏
    function showLoading() {
        if (productGrid) {
            productGrid.classList.add('loading');
            productGrid.style.position = 'relative';
        }
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–∫—Ä—ã—Ç–∏—è –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ –∑–∞–≥—Ä—É–∑–∫–∏
    function hideLoading() {
        if (productGrid) {
            productGrid.classList.remove('loading');
        }
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã
    function autoSubmit() {
        // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è —Å–ª–∏—à–∫–æ–º —á–∞—Å—Ç—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
        clearTimeout(window.submitTimeout);
        window.submitTimeout = setTimeout(() => {
            showLoading();
            filterForm.submit();
        }, 500);
    }
    
    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è select —ç–ª–µ–º–µ–Ω—Ç–æ–≤
    selects.forEach(select => {
        select.addEventListener('change', autoSubmit);
    });
    
    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è input —ç–ª–µ–º–µ–Ω—Ç–æ–≤ (—Å –∑–∞–¥–µ—Ä–∂–∫–æ–π)
    inputs.forEach(input => {
        input.addEventListener('input', autoSubmit);
    });
    
    // –ü–ª–∞–≤–Ω–∞—è –ø—Ä–æ–∫—Ä—É—Ç–∫–∞ –∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º –ø–æ—Å–ª–µ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
    if (window.location.search) {
        setTimeout(() => {
            if (productGrid) {
                productGrid.scrollIntoView({ 
                    behavior: 'smooth', 
                    block: 'start' 
                });
            }
        }, 100);
    }
    
    // –°–∫—Ä—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    hideLoading();
});
</script>
